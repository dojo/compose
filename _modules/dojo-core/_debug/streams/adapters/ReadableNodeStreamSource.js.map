{"version":3,"file":"ReadableNodeStreamSource.js","sourceRoot":"","sources":["ReadableNodeStreamSource.ts"],"names":["ReadableNodeStreamSource","ReadableNodeStreamSource.constructor","ReadableNodeStreamSource._close","ReadableNodeStreamSource._handleClose","ReadableNodeStreamSource._handleError","ReadableNodeStreamSource._removeListeners","ReadableNodeStreamSource.cancel","ReadableNodeStreamSource.pull","ReadableNodeStreamSource.start"],"mappings":"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","sourcesContent":["import Promise from '../../Promise';\nimport { Source } from '../ReadableStream';\nimport ReadableStreamController from '../ReadableStreamController';\nimport { Readable } from 'stream';\n\nexport type NodeSourceType = Buffer | string;\n\nexport default class ReadableNodeStreamSource implements Source<NodeSourceType> {\n\tprotected _controller: ReadableStreamController<NodeSourceType>;\n\tprotected _isClosed: boolean;\n\tprotected _onClose: () => void;\n\tprotected _onError: (error: Error) => void;\n\tprotected _nodeStream: Readable;\n\tprotected _shouldResume: boolean;\n\n\tconstructor(nodeStream: Readable) {;\n\t\tthis._isClosed = false;\n\t\tthis._nodeStream = nodeStream;\n\n\t\t// TODO: remove <any> when typedef is fixed to include 'isPaused'\n\t\tthis._shouldResume = !(<any> this._nodeStream).isPaused();\n\n\t\tif (this._shouldResume) {\n\t\t\t// put stream in paused mode so it behaves as a pull source, rather than a push source\n\t\t\tthis._nodeStream.pause();\n\t\t}\n\t}\n\n\t// Perform internal close logic\n\tprotected _close(): void {\n\t\tthis._isClosed = true;\n\t\tthis._removeListeners();\n\t\tthis._nodeStream.unpipe();\n\n\t\tif (this._shouldResume) {\n\t\t\tthis._nodeStream.resume();\n\t\t}\n\t}\n\n\t// Handle external request to close\n\tprotected _handleClose(): void {\n\t\tthis._close();\n\t\tthis._controller.close();\n\t}\n\n\tprotected _handleError(error: Error): void {\n\t\tthis._close();\n\t\tthis._controller.error(error);\n\t}\n\n\tprotected _removeListeners(): void {\n\t\tthis._nodeStream.removeListener('close', this._onClose);\n\t\tthis._nodeStream.removeListener('end', this._onClose);\n\t\tthis._nodeStream.removeListener('error', this._onError);\n\t}\n\n\tcancel(reason?: any): Promise<void> {\n\t\tthis._handleClose();\n\n\t\treturn Promise.resolve();\n\t}\n\n\tpull(controller: ReadableStreamController<NodeSourceType>): Promise<void> {\n\t\tif (this._isClosed) {\n\t\t\treturn Promise.reject(new Error('Stream is closed'));\n\t\t}\n\n\t\tconst chunk = this._nodeStream.read();\n\n\t\tif (chunk === null) {\n\t\t\tthis._handleClose();\n\t\t}\n\t\telse {\n\t\t\tcontroller.enqueue(chunk);\n\t\t}\n\n\t\treturn Promise.resolve();\n\t}\n\n\tstart(controller: ReadableStreamController<NodeSourceType>): Promise<void> {\n\t\tthis._controller = controller;\n\t\tthis._onClose = this._handleClose.bind(this);\n\t\tthis._onError = this._handleError.bind(this);\n\n\t\tthis._nodeStream.on('close', this._onClose);\n\t\tthis._nodeStream.on('end', this._onClose);\n\t\tthis._nodeStream.on('error', this._onError);\n\n\t\treturn Promise.resolve();\n\t}\n}\n"]}