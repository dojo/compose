{"version":3,"file":"node.js","sourceRoot":"","sources":["node.ts"],"names":["normalizeHeaders","node"],"mappings":"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","sourcesContent":["import Task from '../async/Task';\nimport RequestTimeoutError from './errors/RequestTimeoutError';\nimport { Handle } from '../interfaces';\nimport * as http from 'http';\nimport * as https from 'https';\nimport { createHandle } from '../lang';\nimport { RequestError, RequestOptions, Response, ResponsePromise } from '../request';\nimport ReadableNodeStreamSource from '../streams/adapters/ReadableNodeStreamSource';\nimport WritableNodeStreamSink from '../streams/adapters/WritableNodeStreamSink';\nimport ReadableStream from '../streams/ReadableStream';\nimport WritableStream from '../streams/WritableStream';\nimport * as urlUtil from 'url';\nimport { generateRequestUrl } from './util';\n\n// TODO: Where should the dojo version come from? It used to be kernel, but we don't have that.\nlet version = '2.0.0-pre';\n\ninterface Options {\n\tagent?: any;\n\tauth?: string;\n\theaders?: { [name: string]: string; };\n\thost?: string;\n\thostname?: string;\n\tlocalAddress?: string;\n\tmethod?: string;\n\tpath?: string;\n\tport?: number;\n\tsocketPath?: string;\n}\n\ninterface HttpsOptions extends Options {\n\tca?: any;\n\tcert?: string;\n\tciphers?: string;\n\tkey?: string;\n\tpassphrase?: string;\n\tpfx?: any;\n\trejectUnauthorized?: boolean;\n\tsecureProtocol?: string;\n}\n\nexport interface NodeRequestOptions<T> extends RequestOptions {\n\tagent?: any;\n\tca?: any;\n\tcert?: string;\n\tciphers?: string;\n\tdataEncoding?: string;\n\tfollowRedirects?: boolean;\n\tkey?: string;\n\tlocalAddress?: string;\n\tpassphrase?: string;\n\tpfx?: any;\n\tproxy?: string;\n\trejectUnauthorized?: boolean;\n\tsecureProtocol?: string;\n\tsocketPath?: string;\n\tsocketOptions?: {\n\t\tkeepAlive?: number;\n\t\tnoDelay?: boolean;\n\t\ttimeout?: number;\n\t};\n\tstreamData?: boolean;\n\tstreamEncoding?: string;\n\tstreamTarget?: WritableStream<T>;\n}\n\nfunction normalizeHeaders(headers: { [name: string]: string }): { [name: string]: string } {\n\tconst normalizedHeaders: { [name: string]: string } = {};\n\tfor (let key in headers) {\n\t\tnormalizedHeaders[key.toLowerCase()] = headers[key];\n\t}\n\n\treturn normalizedHeaders;\n}\n\nexport default function node<T>(url: string, options: NodeRequestOptions<T> = {}): ResponsePromise<T> {\n\tconst requestUrl = generateRequestUrl(url, options);\n\tconst parsedUrl = urlUtil.parse(options.proxy || requestUrl);\n\tconst requestOptions: HttpsOptions = {\n\t\tagent: options.agent,\n\t\tauth: parsedUrl.auth || options.auth,\n\t\tca: options.ca,\n\t\tcert: options.cert,\n\t\tciphers: options.ciphers,\n\t\theaders: normalizeHeaders(options.headers || {}),\n\t\thost: parsedUrl.host,\n\t\thostname: parsedUrl.hostname,\n\t\tkey: options.key,\n\t\tlocalAddress: options.localAddress,\n\t\tmethod: options.method ? options.method.toUpperCase() : 'GET',\n\t\tpassphrase: options.passphrase,\n\t\tpath: parsedUrl.path,\n\t\tpfx: options.pfx,\n\t\tport: Number(parsedUrl.port),\n\t\trejectUnauthorized: options.rejectUnauthorized,\n\t\tsecureProtocol: options.secureProtocol,\n\t\tsocketPath: options.socketPath\n\t};\n\n\tif (!('user-agent' in requestOptions.headers)) {\n\t\trequestOptions.headers['user-agent'] = 'dojo/' + version + ' Node.js/' + process.version.replace(/^v/, '');\n\t}\n\n\tif (options.proxy) {\n\t\trequestOptions.path = requestUrl;\n\t\tif (parsedUrl.auth) {\n\t\t\trequestOptions.headers['proxy-authorization'] = 'Basic ' + new Buffer(parsedUrl.auth).toString('base64');\n\t\t}\n\n\t\tlet _parsedUrl = urlUtil.parse(requestUrl);\n\t\trequestOptions.headers['host'] = _parsedUrl.host;\n\t\trequestOptions.auth = _parsedUrl.auth || options.auth;\n\t}\n\n\tif (!options.auth && (options.user || options.password)) {\n\t\trequestOptions.auth = encodeURIComponent(options.user || '') + ':' + encodeURIComponent(options.password || '');\n\t}\n\n\tconst request = (parsedUrl.protocol === 'https:' ? https : http).request(requestOptions);\n\tconst response: Response<T> = {\n\t\tdata: null,\n\t\tgetHeader: function (name: string): string {\n\t\t\treturn (this.nativeResponse && this.nativeResponse.headers[name.toLowerCase()]) || null;\n\t\t},\n\t\trequestOptions: options,\n\t\tstatusCode: null,\n\t\turl: requestUrl\n\t};\n\n\tconst promise = new Task<Response<T>>(function (resolve, reject) {\n\t\tif (options.socketOptions) {\n\t\t\tif ('timeout' in options.socketOptions) {\n\t\t\t\trequest.setTimeout(options.socketOptions.timeout);\n\t\t\t}\n\n\t\t\tif ('noDelay' in options.socketOptions) {\n\t\t\t\trequest.setNoDelay(options.socketOptions.noDelay);\n\t\t\t}\n\n\t\t\tif ('keepAlive' in options.socketOptions) {\n\t\t\t\tconst initialDelay: number = options.socketOptions.keepAlive;\n\t\t\t\trequest.setSocketKeepAlive(initialDelay >= 0, initialDelay);\n\t\t\t}\n\t\t}\n\n\t\tlet timeout: Handle;\n\t\trequest.once('response', function (nativeResponse: http.ClientResponse): void {\n\t\t\tresponse.nativeResponse = nativeResponse;\n\t\t\tresponse.statusCode = nativeResponse.statusCode;\n\n\t\t\t// Redirection handling defaults to true in order to harmonise with the XHR provider, which will always\n\t\t\t// follow redirects\n\t\t\t// TODO: This redirect code is not 100% correct according to the RFC; needs to handle redirect loops and\n\t\t\t// restrict/modify certain redirects\n\t\t\tif (\n\t\t\t\tresponse.statusCode >= 300 &&\n\t\t\t\tresponse.statusCode < 400 &&\n\t\t\t\tresponse.statusCode !== 304 &&\n\t\t\t\toptions.followRedirects !== false &&\n\t\t\t\tnativeResponse.headers.location\n\t\t\t) {\n\t\t\t\tresolve(node(nativeResponse.headers.location, options));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\toptions.streamEncoding && nativeResponse.setEncoding(options.streamEncoding);\n\t\t\tif (options.streamTarget) {\n\t\t\t\tconst responseSource = new ReadableNodeStreamSource(nativeResponse);\n\t\t\t\tconst responseReadableStream = new ReadableStream(responseSource);\n\n\t\t\t\tresponseReadableStream.pipeTo(<any> options.streamTarget)\n\t\t\t\t\t.then(\n\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\tresolve(response);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfunction (error: RequestError<T>) {\n\t\t\t\t\t\t\toptions.streamTarget.abort(error);\n\t\t\t\t\t\t\trequest.abort();\n\t\t\t\t\t\t\terror.response = response;\n\t\t\t\t\t\t\treject(error);\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\tlet data: any[];\n\t\t\tlet loaded: number;\n\t\t\tif (!options.streamData) {\n\t\t\t\tdata = [];\n\t\t\t\tloaded = 0;\n\n\t\t\t\tnativeResponse.on('data', function (chunk: any): void {\n\t\t\t\t\tdata.push(chunk);\n\t\t\t\t\tloaded += (typeof chunk === 'string') ?\n\t\t\t\t\t\tBuffer.byteLength(chunk, options.streamEncoding) :\n\t\t\t\t\t\tchunk.length;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tnativeResponse.once('end', function (): void {\n\t\t\t\ttimeout && timeout.destroy();\n\n\t\t\t\tif (!options.streamData) {\n\t\t\t\t\t// TODO: what type should data have?\n\t\t\t\t\tresponse.data = <any> (options.streamEncoding ? data.join('') : Buffer.concat(data, loaded));\n\t\t\t\t}\n\n\t\t\t\t// If using a streamTarget, wait for it to finish in case it throws an error\n\t\t\t\tif (!options.streamTarget) {\n\t\t\t\t\tresolve(response);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\toptions.streamTarget.close();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\trequest.once('error', reject);\n\n\t\tif (options.data) {\n\t\t\tif (options.data instanceof ReadableStream) {\n\t\t\t\tconst requestSink = new WritableNodeStreamSink(request);\n\t\t\t\tconst writableRequest = new WritableStream(requestSink);\n\t\t\t\toptions.data.pipeTo(writableRequest)\n\t\t\t\t\t.catch(function (error: RequestError<T>) {\n\t\t\t\t\t\terror.response = response;\n\t\t\t\t\t\twritableRequest.abort(error);\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t}\n\t\t\telse {\n\t\t\t\trequest.end();\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\trequest.end();\n\t\t}\n\n\t\tif (options.timeout > 0 && options.timeout !== Infinity) {\n\t\t\ttimeout = (function (): Handle {\n\t\t\t\tconst timer = setTimeout(function (): void {\n\t\t\t\t\tconst error = new RequestTimeoutError('Request timed out after ' + options.timeout + 'ms');\n\t\t\t\t\terror.response = response;\n\t\t\t\t\treject(error);\n\t\t\t\t}, options.timeout);\n\n\t\t\t\treturn createHandle(function (): void {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t});\n\t\t\t})();\n\t\t}\n\t}, function () {\n\t\trequest.abort();\n\t}).catch(function (error: Error): any {\n\t\tlet parsedUrl = urlUtil.parse(url);\n\n\t\tif (parsedUrl.auth) {\n\t\t\tparsedUrl.auth = '(redacted)';\n\t\t}\n\n\t\tlet sanitizedUrl = urlUtil.format(parsedUrl);\n\n\t\terror.message = '[' + requestOptions.method + ' ' + sanitizedUrl + '] ' + error.message;\n\t\tthrow error;\n\t});\n\n\treturn promise;\n}\n"]}